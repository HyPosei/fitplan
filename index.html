<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="version" content="2.1.0">
  <meta name="theme-color" content="#ec4899">
  <meta name="description" content="Kişisel spor programın - Ağırlık takibi, ilerleme ve daha fazlası">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FitPlan">
  <link rel="apple-touch-icon" href="./icon-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
  <link rel="manifest" href="./manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <title>FitPlan - Senin Programın</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;
      --bg-input: #f1f3f5;
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --accent: #ec4899;
      --accent-hover: #db2777;
      --accent-glow: rgba(236, 72, 153, 0.2);
      --success: #10b981;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --gradient-primary: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      --gradient-card: linear-gradient(135deg, #fdf2f8 0%, #ffffff 100%);
    }

    html,
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 440px;
      margin: 0 auto;
      padding: 24px 20px;
      padding-bottom: 120px;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 32px 0 40px;
    }

    .header .logo {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .header p {
      font-size: 15px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .card-label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    /* Input Fields */
    .input-group {
      position: relative;
    }

    .input-group input {
      width: 100%;
      font-family: 'Inter', sans-serif;
      font-size: 36px;
      font-weight: 700;
      text-align: center;
      padding: 20px;
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }

    .input-group input::placeholder {
      color: var(--text-muted);
    }

    .input-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .input-group .unit {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      font-weight: 600;
      color: var(--text-muted);
    }

    /* Goal Buttons */
    .goal-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .goal-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .goal-btn:active {
      transform: scale(0.98);
    }

    .goal-btn.selected {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .goal-btn .icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .goal-btn[data-goal="kilo_verme"] .icon {
      background: linear-gradient(135deg, #f97316, #ea580c);
    }

    .goal-btn[data-goal="sikilasma"] .icon {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .goal-btn[data-goal="kas"] .icon {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .goal-btn[data-goal="kol"] .icon {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
    }

    .goal-btn[data-goal="karin"] .icon {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .goal-btn[data-goal="bacak"] .icon {
      background: linear-gradient(135deg, #ec4899, #db2777);
    }

    .goal-btn .label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .goal-btn .check {
      display: none;
      margin-left: auto;
      width: 20px;
      height: 20px;
      background: var(--accent);
      border-radius: 50%;
      align-items: center;
      justify-content: center;
    }

    .goal-btn .check svg {
      width: 12px;
      height: 12px;
      stroke: white;
      stroke-width: 3;
    }

    .goal-btn.selected .check {
      display: flex;
    }

    /* Day Buttons */
    .day-grid {
      display: flex;
      gap: 10px;
    }

    .day-btn {
      flex: 1;
      padding: 20px 0;
      font-family: 'Inter', sans-serif;
      font-size: 24px;
      font-weight: 700;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: transparent;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-btn:active {
      transform: scale(0.98);
    }

    .day-btn.selected {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
    }

    /* Fixed Bottom Button */
    .fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, var(--bg-primary) 80%, transparent);
      z-index: 100;
    }

    .fixed-bottom .btn-primary {
      display: block;
      width: 100%;
      max-width: 440px;
      margin: 0 auto;
    }

    .btn-primary {
      width: 100%;
      padding: 18px;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 700;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 14px var(--accent-glow);
    }

    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    .btn-primary:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    /* Program Section */
    #program-section {
      display: none;
      padding-top: 20px;
    }

    .program-header {
      margin-bottom: 24px;
    }

    .program-header h2 {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .program-summary {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .summary-badge {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* Day Accordion */
    .day-section {
      margin-bottom: 12px;
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-header.active {
      background: var(--accent);
      border-color: var(--accent);
      border-radius: 12px 12px 0 0;
    }

    .day-header h3 {
      font-size: 16px;
      font-weight: 700;
    }

    .day-header .count {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .day-header.active .count {
      color: rgba(255, 255, 255, 0.8);
    }

    .day-header .arrow {
      font-size: 12px;
      transition: transform 0.2s;
    }

    .day-header.active .arrow {
      transform: rotate(180deg);
    }

    .day-content {
      display: none;
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 16px;
      background: var(--bg-primary);
    }

    .day-content.active {
      display: block;
    }

    /* Exercise Card */
    .exercise-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .exercise-card.completed {
      background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
      border-color: #fbcfe8;
    }

    .exercise-card:last-child {
      margin-bottom: 0;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .exercise-name {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .exercise-target {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .exercise-sets {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
    }

    .exercise-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .exercise-meta span {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Video Container */
    .video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: var(--bg-input);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .video-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .video-placeholder:hover {
      background: var(--border);
    }

    .video-placeholder .play-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .video-placeholder .play-icon svg {
      width: 24px;
      height: 24px;
      fill: white;
      margin-left: 3px;
    }

    .video-placeholder .play-text {
      font-size: 14px;
      font-weight: 500;
    }

    /* Buttons Row */
    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .btn-secondary {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .btn-youtube {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-youtube:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Checkbox */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-input);
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      accent-color: var(--success);
    }

    .checkbox-row label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
    }

    /* Tip */
    .exercise-tip {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      font-size: 13px;
      color: var(--accent);
    }

    .exercise-tip svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* Motivational Footer */
    .motivation-box {
      text-align: center;
      padding: 40px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-top: 24px;
    }

    .motivation-box h3 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .motivation-box p {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Reset Button */
    .btn-reset {
      display: block;
      width: 100%;
      padding: 16px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      background: transparent;
      border: none;
      cursor: pointer;
      margin: 24px 0 40px;
    }

    .btn-reset:hover {
      color: var(--text-secondary);
    }

    /* Weight Input */
    .weight-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .weight-input label {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 60px;
    }

    .weight-input input {
      flex: 1;
      padding: 10px;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      font-weight: 600;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      text-align: center;
    }

    .weight-input input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .weight-input .unit-label {
      font-size: 13px;
      color: var(--text-muted);
      min-width: 25px;
    }

    /* Progress Bar */
    .progress-container {
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 6px;
      background: var(--bg-input);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      text-align: center;
    }

    /* Timer (Floating) */
    .timer-float {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 99;
      min-width: 140px;
      display: none;
    }

    .timer-float.active {
      display: block;
    }

    .timer-display {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      text-align: center;
      margin-bottom: 8px;
    }

    .timer-controls {
      display: flex;
      gap: 8px;
    }

    .timer-btn {
      flex: 1;
      padding: 8px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-input);
      color: var(--text-primary);
      cursor: pointer;
    }

    .timer-btn:active {
      transform: scale(0.95);
    }

    .timer-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Today Button */
    .today-btn {
      width: 100%;
      padding: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 24px;
      box-shadow: 0 4px 14px var(--accent-glow);
    }

    .today-btn:active {
      transform: scale(0.98);
    }

    .today-btn .subtitle {
      font-size: 13px;
      font-weight: 400;
      opacity: 0.9;
      margin-top: 4px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    /* Number input */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* Subtle Info */
    .info-text {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">FitPlan</div>
      <h1>Spor Programın</h1>
      <p>Sana özel, basit ve etkili</p>
    </div>

    <!-- Questions Section -->
    <div id="questions-section">
      <!-- Height -->
      <div class="card">
        <div class="card-label">1 / 5</div>
        <div class="card-title">Boyun kaç cm?</div>
        <div class="input-group">
          <input type="number" id="height" placeholder="170" inputmode="numeric">
          <span class="unit">cm</span>
        </div>
      </div>

      <!-- Weight -->
      <div class="card">
        <div class="card-label">2 / 5</div>
        <div class="card-title">Kilon kaç kg?</div>
        <div class="input-group">
          <input type="number" id="weight" placeholder="70" inputmode="numeric">
          <span class="unit">kg</span>
        </div>
      </div>

      <!-- Age -->
      <div class="card">
        <div class="card-label">3 / 5</div>
        <div class="card-title">Kaç yaşındasın?</div>
        <div class="input-group">
          <input type="number" id="age" placeholder="25" inputmode="numeric">
          <span class="unit">yaş</span>
        </div>
      </div>

      <!-- Goals -->
      <div class="card">
        <div class="card-label">4 / 5</div>
        <div class="card-title">Ne istiyorsun?</div>
        <p class="info-text">Birden fazla seçebilirsin</p>
        <div class="goal-grid">
          <button class="goal-btn" data-goal="kilo_verme">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
                stroke-linecap="round">
                <path d="M12 2v20M2 12h20" />
              </svg>
            </div>
            <span class="label">Kilo Vermek</span>
            <span class="check">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12l5 5L20 7" stroke="currentColor" />
              </svg>
            </span>
          </button>
          <button class="goal-btn" data-goal="sikilasma">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
                stroke-linecap="round">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 6v6l4 2" />
              </svg>
            </div>
            <span class="label">Sıkılaşmak</span>
            <span class="check">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12l5 5L20 7" stroke="currentColor" />
              </svg>
            </span>
          </button>
          <button class="goal-btn" data-goal="kas">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
                stroke-linecap="round">
                <path d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <span class="label">Kas Yapmak</span>
            <span class="check">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12l5 5L20 7" stroke="currentColor" />
              </svg>
            </span>
          </button>
          <button class="goal-btn" data-goal="kol">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
                stroke-linecap="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                <line x1="4" y1="22" x2="4" y2="15" />
              </svg>
            </div>
            <span class="label">Kol</span>
            <span class="check">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12l5 5L20 7" stroke="currentColor" />
              </svg>
            </span>
          </button>
          <button class="goal-btn" data-goal="karin">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
                stroke-linecap="round">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <line x1="3" y1="9" x2="21" y2="9" />
                <line x1="9" y1="21" x2="9" y2="9" />
              </svg>
            </div>
            <span class="label">Karın</span>
            <span class="check">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12l5 5L20 7" stroke="currentColor" />
              </svg>
            </span>
          </button>
          <button class="goal-btn" data-goal="bacak">
            <div class="icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
                stroke-linecap="round">
                <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z" />
              </svg>
            </div>
            <span class="label">Bacak & Kalça</span>
            <span class="check">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12l5 5L20 7" stroke="currentColor" />
              </svg>
            </span>
          </button>
        </div>
      </div>

      <!-- Days per Week -->
      <div class="card">
        <div class="card-label">5 / 5</div>
        <div class="card-title">Haftada kaç gün?</div>
        <div class="day-grid">
          <button class="day-btn" data-days="2">2</button>
          <button class="day-btn" data-days="3">3</button>
          <button class="day-btn" data-days="4">4</button>
          <button class="day-btn" data-days="5">5</button>
        </div>
      </div>
    </div>

    <!-- Program Section -->
    <div id="program-section">
      <div class="program-header">
        <h2>Senin Programın</h2>
        <div class="program-summary" id="program-summary"></div>
      </div>
      <div id="days-container"></div>

      <div class="motivation-box">
        <h3>Hazırsın!</h3>
        <p>Bugün harika iş çıkaracaksın. Başarılar!</p>
      </div>

      <button class="btn-reset" onclick="resetApp()">Baştan Başla</button>
    </div>
  </div>

  <!-- Fixed Bottom Button -->
  <div class="fixed-bottom" id="fixed-bottom">
    <button class="btn-primary" id="show-program-btn" onclick="showProgram()">
      Programımı Göster
    </button>
  </div>

  <!-- Floating Timer -->
  <div class="timer-float" id="timer-widget">
    <div class="timer-display" id="timer-display">00:00</div>
    <div class="timer-controls">
      <button class="timer-btn primary" id="timer-start" onclick="startTimer()">Başlat</button>
      <button class="timer-btn" id="timer-stop" onclick="stopTimer()">Durdur</button>
      <button class="timer-btn" id="timer-reset" onclick="resetTimer()">Sıfırla</button>
    </div>
  </div>

  <script>
    // ============================================
    // EXERCISE DATA
    // ============================================
    const exercises = [
      // GÖĞÜS
      { id: "bench_press", name: "Barbell Bench Press", goals: ["kas", "sikilasma"], target: "Göğüs", sets: 4, reps: "8-12", rest: 90, videoId: "cHwutxa3XLY", howToLink: "https://www.youtube.com/watch?v=cHwutxa3XLY", tip: "Barı göğüs hizasından yukarı it" },
      { id: "incline_press", name: "Incline Bench Press", goals: ["kas"], target: "Üst Göğüs", sets: 4, reps: "8-12", rest: 90, videoId: "3upIH4tyAQE", howToLink: "https://www.youtube.com/watch?v=3upIH4tyAQE", tip: "Üst göğüsü hedefle" },
      { id: "dumbbell_fly", name: "Dumbbell Fly", goals: ["sikilasma", "kas"], target: "Göğüs İzolasyon", sets: 3, reps: "12-15", rest: 60, videoId: "Gth_I4CEAB0", howToLink: "https://www.youtube.com/watch?v=Gth_I4CEAB0", tip: "Göğsü esnet ve sıkıştır" },
      { id: "cable_crossover", name: "Cable Crossover", goals: ["sikilasma"], target: "Göğüs İç", sets: 3, reps: "12-15", rest: 60, videoId: "2E1x1MvR9qo", howToLink: "https://www.youtube.com/watch?v=2E1x1MvR9qo", tip: "Sürekli gerginlik altında tut" },
      { id: "chest_press_machine", name: "Chest Press Makinesi", goals: ["kas", "sikilasma"], target: "Göğüs", sets: 3, reps: "10-12", rest: 60, videoId: "2wFMkurVmrQ", howToLink: "https://www.youtube.com/watch?v=2wFMkurVmrQ", tip: "Güvenli ve kontrollü hareket" },
      { id: "pushup", name: "Push-Up", goals: ["kilo_verme", "sikilasma", "kas", "kol"], target: "Göğüs & Kol", sets: 3, reps: "15-20", rest: 60, videoId: "RyzxRrBHn7k", howToLink: "https://www.youtube.com/watch?v=RyzxRrBHn7k", tip: "Vücudun düz bir çizgi olmalı" },
      { id: "dips", name: "Dips", goals: ["kas", "sikilasma", "kol"], target: "Alt Göğüs & Triceps", sets: 3, reps: "8-12", rest: 90, videoId: "H9G1wL4yujU", howToLink: "https://www.youtube.com/watch?v=H9G1wL4yujU", tip: "Paralel barlarda kontrollü in-çık" },

      // SIRT
      { id: "pullup", name: "Pull-Up", goals: ["kas", "kilo_verme", "sikilasma"], target: "Sırt & Biceps", sets: 3, reps: "6-10", rest: 90, videoId: "eu3pSe55-Qg", howToLink: "https://www.youtube.com/watch?v=eu3pSe55-Qg", tip: "Üst vücut çekiş gücü için temel" },
      { id: "lat_pulldown", name: "Lat Pulldown", goals: ["kas", "sikilasma"], target: "Kanat Kasları", sets: 4, reps: "10-12", rest: 60, videoId: "hEt8rkd7-Gk", howToLink: "https://www.youtube.com/watch?v=hEt8rkd7-Gk", tip: "Barfiks alternatifi" },
      { id: "barbell_row", name: "Barbell Row", goals: ["kas", "sikilasma"], target: "Orta Sırt", sets: 4, reps: "8-12", rest: 90, videoId: "-lGIRM-tbDk", howToLink: "https://www.youtube.com/watch?v=-lGIRM-tbDk", tip: "Sırt kalınlığı ve güç için" },
      { id: "seated_cable_row", name: "Seated Cable Row", goals: ["sikilasma", "kas"], target: "Orta Sırt", sets: 3, reps: "12-15", rest: 60, videoId: "DOlLdf20xf0", howToLink: "https://www.youtube.com/watch?v=DOlLdf20xf0", tip: "Oturarak sırt çekiş hareketi" },
      { id: "hyperextension", name: "Hyperextension", goals: ["sikilasma", "karin"], target: "Alt Sırt & Bel", sets: 3, reps: "12-15", rest: 45, videoId: "cfdi2mTOv6Q", howToLink: "https://www.youtube.com/watch?v=cfdi2mTOv6Q", tip: "Bel kaslarını güçlendir" },

      // OMUZ
      { id: "overhead_press", name: "Overhead Press", goals: ["kas", "kol"], target: "Ön & Orta Omuz", sets: 4, reps: "8-12", rest: 90, videoId: "13YElyAtd84", howToLink: "https://www.youtube.com/watch?v=13YElyAtd84", tip: "Temel dikey itiş hareketi" },
      { id: "lateral_raise", name: "Lateral Raise", goals: ["sikilasma", "kol"], target: "Orta Omuz", sets: 3, reps: "12-15", rest: 45, videoId: "weDBwj9Kuaw", howToLink: "https://www.youtube.com/watch?v=weDBwj9Kuaw", tip: "Omuz genişliği kazandırır" },
      { id: "face_pull", name: "Face Pull", goals: ["sikilasma"], target: "Arka Omuz", sets: 3, reps: "15-20", rest: 45, videoId: "vuDO21_zqbQ", howToLink: "https://www.youtube.com/watch?v=vuDO21_zqbQ", tip: "Postür düzeltici hareket" },

      // KOL
      { id: "barbell_curl", name: "Barbell Curl", goals: ["kas", "kol"], target: "Biceps", sets: 3, reps: "10-12", rest: 60, videoId: "M3qQOkiJfoU", howToLink: "https://www.youtube.com/watch?v=M3qQOkiJfoU", tip: "Ön kol hacmi için temel curl" },
      { id: "hammer_curl", name: "Hammer Curl", goals: ["kas", "kol"], target: "Biceps & Ön Kol", sets: 3, reps: "10-12", rest: 60, videoId: "X98pBvg1mJ8", howToLink: "https://www.youtube.com/watch?v=X98pBvg1mJ8", tip: "Biceps kalınlığı sağlar" },
      { id: "triceps_pushdown", name: "Triceps Pushdown", goals: ["kas", "sikilasma", "kol"], target: "Triceps", sets: 3, reps: "12-15", rest: 60, videoId: "YsirG0x9Pf4", howToLink: "https://www.youtube.com/watch?v=YsirG0x9Pf4", tip: "Arka kol izolasyon hareketi" },

      // BACAK
      { id: "squat", name: "Squat", goals: ["kas", "kilo_verme", "sikilasma", "bacak"], target: "Bacak & Kalça", sets: 4, reps: "8-12", rest: 120, videoId: "WZRJW4UpkkE", howToLink: "https://www.youtube.com/watch?v=WZRJW4UpkkE", tip: "Tüm alt vücut için en temel hareket" },
      { id: "leg_press", name: "Leg Press", goals: ["kas", "bacak"], target: "Quadriceps & Kalça", sets: 4, reps: "10-12", rest: 90, videoId: "2q7kXFKsIwY", howToLink: "https://www.youtube.com/watch?v=2q7kXFKsIwY", tip: "Bacak hacmi için güvenli makine" },
      { id: "leg_curl", name: "Leg Curl", goals: ["sikilasma", "bacak"], target: "Hamstring", sets: 3, reps: "12-15", rest: 60, videoId: "69_4qE2o-9A", howToLink: "https://www.youtube.com/watch?v=69_4qE2o-9A", tip: "Arka bacak izolasyonu" },
      { id: "hip_thrust", name: "Hip Thrust", goals: ["kas", "sikilasma", "bacak"], target: "Kalça", sets: 4, reps: "10-15", rest: 90, videoId: "u-lCNOsSGnc", howToLink: "https://www.youtube.com/watch?v=u-lCNOsSGnc", tip: "Kalça kasları için en etkili hareket" },
      { id: "standing_calf_raise", name: "Standing Calf Raise", goals: ["kas", "bacak"], target: "Baldır", sets: 4, reps: "15-20", rest: 45, videoId: "n4czfyhJZXM", howToLink: "https://www.youtube.com/watch?v=n4czfyhJZXM", tip: "Baldır hacmi ve dayanıklılığı için" }
    ];

    // APP STATE
    let selectedGoals = [];
    let selectedDays = null;

    // GOAL BUTTONS
    document.querySelectorAll('.goal-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const goal = this.dataset.goal;
        if (selectedGoals.includes(goal)) {
          selectedGoals = selectedGoals.filter(g => g !== goal);
          this.classList.remove('selected');
        } else {
          selectedGoals.push(goal);
          this.classList.add('selected');
        }
      });
    });

    // DAY BUTTONS
    document.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        selectedDays = parseInt(this.dataset.days);
      });
    });

    // GENERATE PROGRAM
    function generateProgram() {
      let matchingExercises = exercises.filter(ex =>
        ex.goals.some(g => selectedGoals.includes(g))
      );
      if (matchingExercises.length === 0) matchingExercises = [...exercises];
      matchingExercises = shuffleArray(matchingExercises);

      const days = [];
      const exercisesPerDay = 6;
      let exerciseIndex = 0;

      for (let d = 0; d < selectedDays; d++) {
        const dayExercises = [];
        for (let i = 0; i < exercisesPerDay && exerciseIndex < matchingExercises.length; i++) {
          dayExercises.push(matchingExercises[exerciseIndex]);
          exerciseIndex++;
        }
        if (dayExercises.length < exercisesPerDay) {
          exerciseIndex = 0;
          const remaining = exercisesPerDay - dayExercises.length;
          for (let i = 0; i < remaining && i < matchingExercises.length; i++) {
            if (!dayExercises.find(e => e.id === matchingExercises[i].id)) {
              dayExercises.push(matchingExercises[i]);
            }
          }
        }
        days.push(dayExercises);
      }
      return days;
    }

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // SHOW PROGRAM
    function showProgram() {
      const height = document.getElementById('height').value;
      const weight = document.getElementById('weight').value;
      const age = document.getElementById('age').value;

      if (!height || !weight || !age) {
        alert('Lütfen boy, kilo ve yaşını gir');
        return;
      }
      if (selectedGoals.length === 0) {
        alert('Lütfen en az bir hedef seç');
        return;
      }
      if (!selectedDays) {
        alert('Haftada kaç gün spor yapacağını seç');
        return;
      }

      const program = generateProgram();
      const goalLabels = {
        'kilo_verme': 'Kilo Verme',
        'sikilasma': 'Sıkılaşma',
        'kas': 'Kas Yapma',
        'kol': 'Kol',
        'karin': 'Karın',
        'bacak': 'Bacak/Kalça'
      };

      const summaryHtml = `
                <span class="summary-badge">${selectedGoals.map(g => goalLabels[g]).join(', ')}</span>
                <span class="summary-badge">Haftada ${selectedDays} gün</span>
            `;
      document.getElementById('program-summary').innerHTML = summaryHtml;

      const container = document.getElementById('days-container');
      container.innerHTML = '';

      program.forEach((dayExercises, index) => {
        const dayNum = index + 1;
        const dayHtml = `
                    <div class="day-section">
                        <div class="day-header ${dayNum === 1 ? 'active' : ''}" onclick="toggleDay(this)">
                            <h3>Gün ${dayNum}</h3>
                            <span class="count">${dayExercises.length} egzersiz</span>
                            <span class="arrow">▼</span>
                        </div>
                        <div class="day-content ${dayNum === 1 ? 'active' : ''}">
                            <div class="progress-container" data-day="${dayNum}">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <div class="progress-text">0% tamamlandı</div>
                            </div>
                            ${dayExercises.map(ex => renderExerciseCard(ex, dayNum)).join('')}
                        </div>
                    </div>
                `;
        container.innerHTML += dayHtml;
      });

      // Save user answers for "Today" button
      localStorage.setItem('fitplanUserAnswers', JSON.stringify({
        daysPerWeek: selectedDays,
        goals: selectedGoals
      }));

      loadProgress();
      updateProgressBars();
      showTodayButton();

      document.getElementById('questions-section').style.display = 'none';
      document.getElementById('program-section').style.display = 'block';
      document.getElementById('fixed-bottom').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // RENDER EXERCISE CARD
    function renderExerciseCard(exercise, dayNum) {
      const checkboxId = `check_${dayNum}_${exercise.id}`;
      const lastWeight = getLastWeight(dayNum, exercise.id);
      const weightInputId = `weight_${dayNum}_${exercise.id}`;

      return `
                <div class="exercise-card" id="card_${dayNum}_${exercise.id}">
                    <div class="exercise-header">
                        <div>
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-target">${exercise.target}</div>
                        </div>
                        <div class="exercise-sets">${exercise.sets}×${exercise.reps}</div>
                    </div>
                    
                    <div class="exercise-meta">
                        <span>Dinlenme: ${exercise.rest}sn</span>
                    </div>
                    
                    <div class="weight-input">
                        <label>Ağırlık:</label>
                        <input 
                            type="number" 
                            id="${weightInputId}" 
                            placeholder="${lastWeight || '0'}" 
                            value="${lastWeight || ''}"
                            onchange="saveWeight('${dayNum}', '${exercise.id}', this.value)"
                            step="0.5"
                        >
                        <span class="unit-label">kg</span>
                    </div>
                    
                    <div class="video-container" id="video_${dayNum}_${exercise.id}">
                        <div class="video-placeholder" onclick="loadVideo('${dayNum}', '${exercise.id}', '${exercise.videoId}')">
                            <div class="play-icon">
                                <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
                            </div>
                            <div class="play-text">Videoyu İzle</div>
                        </div>
                    </div>
                    
                    <div class="btn-row">
                        <a href="${exercise.howToLink}" target="_blank" class="btn-secondary btn-youtube">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                            YouTube'da Aç
                        </a>
                    </div>
                    
                    <div class="checkbox-row" onclick="toggleCheckbox('${checkboxId}')">
                        <input type="checkbox" id="${checkboxId}" onclick="event.stopPropagation(); toggleComplete('${dayNum}', '${exercise.id}')">
                        <label for="${checkboxId}">Tamamlandı</label>
                    </div>
                    
                    ${exercise.tip ? `
                        <div class="exercise-tip">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <span>${exercise.tip}</span>
                        </div>
                    ` : ''}
                </div>
            `;
    }

    // VIDEO
    function loadVideo(dayNum, exerciseId, videoId) {
      const container = document.getElementById(`video_${dayNum}_${exerciseId}`);
      container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1" title="Video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    }

    // ACCORDION
    function toggleDay(header) {
      const wasActive = header.classList.contains('active');
      document.querySelectorAll('.day-header').forEach(h => h.classList.remove('active'));
      document.querySelectorAll('.day-content').forEach(c => c.classList.remove('active'));
      if (!wasActive) {
        header.classList.add('active');
        header.nextElementSibling.classList.add('active');
      }
    }

    // CHECKBOX
    function toggleCheckbox(checkboxId) {
      const checkbox = document.getElementById(checkboxId);
      checkbox.checked = !checkbox.checked;
      const parts = checkboxId.split('_');
      const dayNum = parts[1];
      const exerciseId = parts.slice(2).join('_');
      toggleComplete(dayNum, exerciseId);
    }

    function toggleComplete(dayNum, exerciseId) {
      const card = document.getElementById(`card_${dayNum}_${exerciseId}`);
      const checkbox = document.getElementById(`check_${dayNum}_${exerciseId}`);
      card.classList.toggle('completed', checkbox.checked);
      saveProgress();
    }

    function saveProgress() {
      const progress = {};
      document.querySelectorAll('.exercise-card input[type="checkbox"]').forEach(cb => {
        progress[cb.id] = cb.checked;
      });
      localStorage.setItem('fitplanProgress', JSON.stringify(progress));
    }

    function loadProgress() {
      try {
        const saved = localStorage.getItem('fitplanProgress');
        if (saved) {
          const progress = JSON.parse(saved);
          Object.keys(progress).forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox && progress[id]) {
              checkbox.checked = true;
              const card = checkbox.closest('.exercise-card');
              if (card) card.classList.add('completed');
            }
          });
        }
      } catch (e) { }
    }

    function resetApp() {
      if (confirm('Baştan başlamak istediğine emin misin?')) {
        localStorage.removeItem('fitplanProgress');
        localStorage.removeItem('fitplanWeights');
        localStorage.removeItem('fitplanTimer');
        localStorage.removeItem('fitplanWeekly');
        location.reload();
      }
    }

    // ============================================
    // TIMER FUNCTIONALITY
    // ============================================
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;

    function startTimer() {
      if (!timerRunning) {
        timerRunning = true;
        const startTime = Date.now() - (timerSeconds * 1000);
        localStorage.setItem('fitplanTimer', JSON.stringify({ startTime, running: true }));

        timerInterval = setInterval(() => {
          timerSeconds = Math.floor((Date.now() - startTime) / 1000);
          updateTimerDisplay();
        }, 100);

        document.getElementById('timer-widget').classList.add('active');
      }
    }

    function stopTimer() {
      if (timerRunning) {
        timerRunning = false;
        clearInterval(timerInterval);
        localStorage.setItem('fitplanTimer', JSON.stringify({ seconds: timerSeconds, running: false }));
      }
    }

    function resetTimer() {
      stopTimer();
      timerSeconds = 0;
      updateTimerDisplay();
      localStorage.removeItem('fitplanTimer');
    }

    function updateTimerDisplay() {
      const mins = Math.floor(timerSeconds / 60);
      const secs = timerSeconds % 60;
      document.getElementById('timer-display').textContent =
        `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function loadTimer() {
      try {
        const saved = localStorage.getItem('fitplanTimer');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.running && data.startTime) {
            timerSeconds = Math.floor((Date.now() - data.startTime) / 1000);
            startTimer();
          } else if (data.seconds) {
            timerSeconds = data.seconds;
            updateTimerDisplay();
            document.getElementById('timer-widget').classList.add('active');
          }
        }
      } catch (e) { }
    }

    // ============================================
    // WEIGHT TRACKING
    // ============================================
    function saveWeight(dayNum, exerciseId, weight) {
      try {
        const weights = JSON.parse(localStorage.getItem('fitplanWeights') || '{}');
        const today = new Date().toISOString().split('T')[0];
        const key = `${dayNum}_${exerciseId}`;

        if (!weights[key]) weights[key] = [];
        weights[key].push({ date: today, weight: parseFloat(weight) });

        // Keep last 30 entries
        if (weights[key].length > 30) weights[key] = weights[key].slice(-30);

        localStorage.setItem('fitplanWeights', JSON.stringify(weights));
      } catch (e) { }
    }

    function getLastWeight(dayNum, exerciseId) {
      try {
        const weights = JSON.parse(localStorage.getItem('fitplanWeights') || '{}');
        const key = `${dayNum}_${exerciseId}`;
        const history = weights[key];
        if (history && history.length > 0) {
          return history[history.length - 1].weight;
        }
      } catch (e) { }
      return null;
    }

    // ============================================
    // PROGRESS CALCULATION
    // ============================================
    function calculateDayProgress(dayNum) {
      const prefix = `check_${dayNum}_`;
      const checkboxes = Array.from(document.querySelectorAll(`input[id^="${prefix}"]`));
      if (checkboxes.length === 0) return 0;
      const completed = checkboxes.filter(cb => cb.checked).length;
      return Math.round((completed / checkboxes.length) * 100);
    }

    function updateProgressBars() {
      document.querySelectorAll('.progress-container').forEach(container => {
        const dayNum = container.dataset.day;
        const progress = calculateDayProgress(dayNum);
        const fill = container.querySelector('.progress-fill');
        const text = container.querySelector('.progress-text');
        if (fill) fill.style.width = `${progress}%`;
        if (text) text.textContent = `${progress}% tamamlandı`;
      });
    }

    // ============================================
    // "TODAY" BUTTON LOGIC
    // ============================================
    function getTodayWorkoutDay() {
      try {
        const userAnswers = JSON.parse(localStorage.getItem('fitplanUserAnswers') || '{}');
        if (!userAnswers.daysPerWeek) return null;

        const daysPerWeek = userAnswers.daysPerWeek;
        const today = new Date().getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

        // Map days based on frequency
        const workoutDays = {
          2: [1, 4], // Mon, Thu
          3: [1, 3, 5], // Mon, Wed, Fri
          4: [1, 2, 4, 5], // Mon, Tue, Thu, Fri
          5: [1, 2, 3, 4, 5] // Mon-Fri
        };

        const scheduledDays = workoutDays[daysPerWeek] || [];
        const dayIndex = scheduledDays.indexOf(today);

        if (dayIndex >= 0) {
          return dayIndex + 1; // Return workout day number (1-indexed)
        }
        return 0; // Rest day
      } catch (e) {
        return null;
      }
    }

    function showTodayButton() {
      const todayDay = getTodayWorkoutDay();
      if (todayDay && todayDay > 0) {
        const button = document.createElement('button');
        button.className = 'today-btn';
        button.innerHTML = `
          Bugünkü Antrenman: Gün ${todayDay}
          <div class="subtitle">Başlamak için tıkla</div>
        `;
        button.onclick = () => scrollToDay(todayDay);

        const programHeader = document.querySelector('.program-header');
        if (programHeader) {
          programHeader.insertAdjacentElement('afterend', button);
        }
      } else if (todayDay === 0) {
        const button = document.createElement('button');
        button.className = 'today-btn';
        button.style.background = 'var(--bg-secondary)';
        button.innerHTML = `
          Bugün Dinlenme Günü
          <div class="subtitle">Yarın devam edelim!</div>
        `;
        button.disabled = true;

        const programHeader = document.querySelector('.program-header');
        if (programHeader) {
          programHeader.insertAdjacentElement('afterend', button);
        }
      }
    }

    function scrollToDay(dayNum) {
      const headers = document.querySelectorAll('.day-header');
      if (headers[dayNum - 1]) {
        headers[dayNum - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => {
          if (!headers[dayNum - 1].classList.contains('active')) {
            headers[dayNum - 1].click();
          }
        }, 500);
      }
    }

    // ============================================
    // WEEKLY ADAPTATION ENGINE  
    // ============================================
    function saveWeeklyCompletion() {
      try {
        const weekStart = getWeekStart();
        const weekly = JSON.parse(localStorage.getItem('fitplanWeekly') || '{}');

        if (!weekly[weekStart]) {
          weekly[weekStart] = { days: {}, totalCompletion: 0 };
        }

        // Calculate completion for each day
        for (let d = 1; d <= selectedDays; d++) {
          weekly[weekStart].days[d] = calculateDayProgress(d);
        }

        // Calculate average completion
        const completionValues = Object.values(weekly[weekStart].days);
        const avgCompletion = completionValues.reduce((a, b) => a + b, 0) / completionValues.length;
        weekly[weekStart].totalCompletion = avgCompletion;

        localStorage.setItem('fitplanWeekly', JSON.stringify(weekly));
      } catch (e) { }
    }

    function getWeekStart() {
      const now = new Date();
      const day = now.getDay();
      const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Monday
      const monday = new Date(now.setDate(diff));
      return monday.toISOString().split('T')[0];
    }

    function getProgressionMultiplier() {
      try {
        const weekly = JSON.parse(localStorage.getItem('fitplanWeekly') || '{}');
        const weeks = Object.keys(weekly).sort().reverse();
        if (weeks.length === 0) return 1.0;

        const lastWeek = weekly[weeks[0]];
        if (!lastWeek) return 1.0;

        const completion = lastWeek.totalCompletion;

        // Progression rules
        if (completion >= 90) return 1.05; // 5% increase
        if (completion >= 70) return 1.0; // Maintain
        return 0.95; // 5% decrease
      } catch (e) {
        return 1.0;
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('load', () => {
      loadTimer();

      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => console.log('SW registered:', registration.scope))
          .catch(err => console.log('SW registration failed:', err));
      }

      // Check if user has previously created a program
      const savedAnswers = localStorage.getItem('fitplanUserAnswers');
      if (savedAnswers) {
        try {
          const answers = JSON.parse(savedAnswers);
          if (answers.daysPerWeek && answers.goals && answers.goals.length > 0) {
            // Restore state
            selectedDays = answers.daysPerWeek;
            selectedGoals = answers.goals;

            // Regenerate program
            const program = generateProgram();

            // Hide questions, show program
            document.getElementById('questions-section').style.display = 'none';
            document.getElementById('program-section').style.display = 'block';
            document.getElementById('fixed-bottom').style.display = 'none';

            // Rebuild UI
            const goalLabels = {
              'kilo_verme': 'Kilo Verme',
              'sikilasma': 'Sıkılaşma',
              'kas': 'Kas Yapma',
              'kol': 'Kol',
              'karin': 'Karın',
              'bacak': 'Bacak/Kalça'
            };

            const summaryHtml = `
              <span class="summary-badge">${selectedGoals.map(g => goalLabels[g]).join(', ')}</span>
              <span class="summary-badge">Haftada ${selectedDays} gün</span>
            `;
            document.getElementById('program-summary').innerHTML = summaryHtml;

            const container = document.getElementById('days-container');
            container.innerHTML = '';

            program.forEach((dayExercises, index) => {
              const dayNum = index + 1;
              const dayHtml = `
                <div class="day-section">
                  <div class="day-header ${dayNum === 1 ? 'active' : ''}" onclick="toggleDay(this)">
                    <h3>Gün ${dayNum}</h3>
                    <span class="count">${dayExercises.length} egzersiz</span>
                    <span class="arrow">▼</span>
                  </div>
                  <div class="day-content ${dayNum === 1 ? 'active' : ''}">
                    <div class="progress-container" data-day="${dayNum}">
                      <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                      </div>
                      <div class="progress-text">0% tamamlandı</div>
                    </div>
                    ${dayExercises.map(ex => renderExerciseCard(ex, dayNum)).join('')}
                  </div>
                </div>
              `;
              container.innerHTML += dayHtml;
            });

            // Restore progress and UI state
            loadProgress();
            updateProgressBars();
            showTodayButton();
          }
        } catch (e) {
          console.error('Error restoring program:', e);
        }
      }
    });

    // Update progress bars whenever checkbox changes
    const originalToggleComplete = toggleComplete;
    toggleComplete = function (dayNum, exerciseId) {
      originalToggleComplete(dayNum, exerciseId);
      updateProgressBars();
      saveWeeklyCompletion();
    };
  </script>
</body>

</html>